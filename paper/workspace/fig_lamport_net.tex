\begin{figure}
\begin{center}
  \begin{tikzpicture}
  \draw[box] (-2,8.5) rectangle (1,0);
  \draw[box] (3,8.5) rectangle (7.5,0);
  
  \node at (-0.5, 0.5) {First Process};
  \node at (5, 0.5) {Second Process};

  \node[place, label=left:p3] (p3) at (0,7) {};
  \node[transition, label=left:u1] (u1) at (0,6) {};
  \node[place, tokens=1, label=left:p1] (p1) at (0,5) {};
  \node[transition, label=left:u2] (u2) at (0,4) {};
  \node[place, label=left:p2] (p2) at (0,3) {};
  \node[transition, label=left:u3] (u3) at (0,2) {};

  \draw (p3) edge[flow] (u1);
  \draw (u1) edge[flow] (p1);
  \draw (p1) edge[flow] (u2);
  \draw (u2) edge[flow] (p2);
  \draw (p2) edge[flow] (u3);
  \draw[rounded corners=4mm] (u3) |- (-1.5,1) -- (-1.5,8) [flow] -| (p3);
 
  \node[transition, label=above:v1] (v1) at (4,7) {};
  \node[place, label=right:q3] (q3) at (4,6) {};
  \node[transition, label=right:v2] (v2) at (4,5) {};
  \node[place, label=right:q4] (q4) at (4,4) {};
  \node[transition, label=left:v3] (v3) at (4,3) {};

  \node[place, label=right:q2] (q2) at (5.5,7) {};
  \node[transition, label=right:v4] (v4) at (5.5,6) {};
  \node[place, label=right:q5] (q5) at (5.5,5) {};
  \node[transition, label=right:v5] (v5) at (5.5,4) {};
  \node[place, tokens=1, label=right:q1] (q1) at (5.5,3) {};
  \node[transition, label=right:v6] (v6) at (5.5,2) {};
  
  \draw (q2) edge[flow] (v4);
  \draw (v4) edge[flow] (q5);
  \draw (q5) edge[flow] (v5);
  \draw (v5) edge[flow] (q1);
  \draw (q1) edge[flow] (v6);
  \draw[rounded corners=4mm] (v6) |- (7,1) -- (7,8) [flow] -| (q2);
  
  \draw (q2) edge[flow] (v1);
  \draw (v1) edge[flow] (q3);
  \draw (q3) edge[flow] (v2);
  \draw (v2) edge[flow] (q4);
  \draw (q4) edge[flow] (v3);
  \draw (v3) edge[flow] (q1);
  
  \node[place, label=above:bit1] (bit1) at (2,6) {};
  \node[place, label=below:$\neg$bit1] (nbit1) at (2,4) {};
  \node[place, label=below:$\neg$bit2] (nbit2) at (2,2) {};
  
  \draw (bit1) edge[flow] (u1);
  \draw (u1) edge[flow] (nbit1);
  \draw (nbit1) edge[flow] (u2);
  \draw (u2) edge[flow] (bit1);
  \draw (v1) edge[flow, <->] (bit1);
  \draw (nbit1) edge[flow, <->, bend left=18] (v4);
  \draw (nbit1) edge[flow, <->] (v3);
  \draw (nbit2) edge[flow, <->] (u3);
  \draw (v2) edge[flow] (nbit2);
  \draw (v5) edge[flow, bend left=30] ([xshift=-0.2mm, yshift=1mm] nbit2.east);
  \draw (nbit2) edge[flow] (v6.west);
\end{tikzpicture}
\end{center}
\caption{Petri net for Lamport's 1-bit algorithm}
\label{fig:lamport-petri-net}
\end{figure}
