\documentclass{scrartcl}

\usepackage{amsmath}
\usepackage{multirow}
\usepackage{dot2texi}
\usepackage{algpseudocode}
\algnewcommand{\LineComment}[1]{\State \(\triangleright\) #1}
\algnewcommand{\ShortComment}[1]{\quad \(\triangleright\) #1}

\usepackage{tikz}
\usetikzlibrary{shapes, shapes.multipart, shapes.geometric}
\usetikzlibrary{positioning}

\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,inner sep=2pt] (char) {#1};}}

\begin{document}

\section{Method}

\subsection{With trap refinement}

\begin{tikzpicture}[
    state/.style   = {draw, ellipse, aspect=2},
    action/.style  = {draw, rectangle, align=center},
    decision/.style= {draw, diamond, aspect=2, align=center},
    print/.style   = {draw, trapezium, trapezium left angle=70, trapezium right angle=-70},
    edge/.style    = {draw, ->, shorten >=2pt, shorten <=2pt},
  ]
  \node[state] (begin) {BEGIN};
  \node[action, below=of begin] (c) {$C:=\mathcal C(N)$};
  \node[decision, below=of c] (satc) {$\text{SAT}(C \cup \{\neg P\})$};
  \node[action, below=of satc] (modelc) {$A:=\text{Model}(C \cup \{\neg P\})$\\
                                   $C_{\theta}:=\text{TrapConditions}(N, A)$};
  \node[decision, below=of modelc] (satctheta) {$\text{SAT}(C_\theta)$};
  \node[action, below=of satctheta] (modelctheta) {$A_\theta:=\text{Model}(C_\theta)$\\
                                        $\delta:=\Delta(A_\theta)$\\
                                        $C:=C \cup \{\delta\}$};
  \node[print, right=of satc] (yes) {YES};
  \node[print, right=of satctheta] (dontknow) {Don't know};
  \node[state, right=of yes] (end1) {END};
  \node[state, right=of dontknow] (end2) {END};

  \draw (begin) edge[edge] (c);
  \draw (c) edge[edge] coordinate[pos=.5] (edgein) (satc);
  \draw (satc) edge[edge] node[above]{NO} (yes);
  \draw (yes) edge[edge] (end1);
  \draw (satc) edge[edge] node[right]{YES} (modelc);
  \draw (modelc) edge[edge] (satctheta);
  \draw (satctheta) edge[edge] node[above]{NO} (dontknow);
  \draw (dontknow) edge[edge] (end2);
  \draw (satctheta) edge[edge] node[right]{YES} (modelctheta);
  \draw[edge] (modelctheta.south) -- ([yshift=-0.5cm] modelctheta.south)
  -| ([xshift=-2cm] modelctheta.west) |- (edgein);
\end{tikzpicture}

\subsection{With trap and subnet trap refinement}

\begin{tikzpicture}[
    state/.style   = {draw, ellipse, aspect=2},
    action/.style  = {draw, rectangle, align=center},
    decision/.style= {draw, diamond, aspect=2, align=center},
    print/.style   = {draw, trapezium, trapezium left angle=70, trapezium right angle=-70},
    edge/.style    = {draw, ->, shorten >=2pt, shorten <=2pt},
  ]
  \node[state] (begin) {BEGIN};
  \node[action, below=of begin] (c) {$C:=\mathcal C(N)$};
  \node[decision, below=of c] (satc) {$\text{SAT}(C \cup \{\neg P\})$};
  \node[action, below=of satc] (modelc) {$A:=\text{Model}(C \cup \{\neg P\})$\\
                                   $C_{\theta}:=\text{TrapConditions}(N, A)$};
  \node[decision, below=of modelc] (satctheta) {$\text{SAT}(C_\theta)$};
  \node[action, below=of satctheta] (modelctheta) {$A_\theta:=\text{Model}(C_\theta)$\\
                                        $\delta:=\Delta(A_\theta)$\\
                                        $C:=C \cup \{\delta\}$};
  \node[print, right=of satc] (yes) {YES};
  \node[action, right=of satctheta] (cthetaprime) {$C_{\theta'}:=\text{SubnetTrapConditions}(N, A)$};
  \node[decision, below=of cthetaprime] (satcthetaprime) {$\text{SAT}(C_{\theta'})$};
  \node[action, below=of satcthetaprime] (modelcthetaprime)
      {$A_{\theta'}:=\text{Model}(C_\theta)$\\
       $\delta':=\Delta'(A_{\theta'})$\\
       $C:=C \cup \{\delta'\}$};
  \node[print, right=of satcthetaprime] (dontknow) {Don't know};
  \node[state, right=of yes] (end1) {END};
  \node[state, right=of dontknow] (end2) {END};

  \draw (begin) edge[edge] (c);
  \draw (c) edge[edge] coordinate[pos=.5] (edgein) (satc);
  \draw (satc) edge[edge] node[above]{NO} (yes);
  \draw (yes) edge[edge] (end1);
  \draw (satc) edge[edge] node[right]{YES} (modelc);
  \draw (modelc) edge[edge] (satctheta);
  \draw (satctheta) edge[edge] node[above]{NO} (cthetaprime);
  \draw (cthetaprime) edge[edge] (satcthetaprime);
  \draw (satcthetaprime) edge[edge] node[above]{NO} (dontknow);
  \draw (dontknow) edge[edge] (end2);
  \draw (satctheta) edge[edge] node[right]{YES} (modelctheta);
  \draw (satcthetaprime) edge[edge] node[right]{YES} (modelcthetaprime);
  \draw[edge] (modelctheta.south) -- ([yshift=-0.5cm] modelctheta.south)
  -| ([xshift=-2cm] modelctheta.west) |- (edgein);
  \draw[edge] (modelcthetaprime.south) -- ([yshift=-0.5cm] modelcthetaprime.south)
  -| ([xshift=-2cm] modelctheta.west) |- (edgein);
\end{tikzpicture}

\subsection{General refinement method}

\begin{tikzpicture}[
    state/.style   = {draw, ellipse, aspect=2},
    action/.style  = {draw, rectangle, align=center},
    decision/.style= {draw, diamond, aspect=2, align=center},
    print/.style   = {draw, trapezium, trapezium left angle=70, trapezium right angle=-70},
    edge/.style    = {draw, ->, shorten >=2pt, shorten <=2pt},
  ]
  \node[state] (begin) {BEGIN};
  \node[action, below=of begin] (c) {$C:=\mathcal C(N)$};
  \node[decision, below=of c] (satc) {$\text{SAT}(C \cup \{\neg P\})$};
  \node[action, below=of satc] (modelc) {$A:=\text{Model}(C \cup \{\neg P\})$\\
                                   $C_{\theta}:=\text{TrapConditions}(N, A)$};
  \node[decision, below=of modelc] (satctheta) {$\text{SAT}(C_\theta)$};
  \node[action, below=of satctheta] (modelctheta) {$A_\theta:=\text{Model}(C_\theta)$\\
                                        $\delta:=\Delta(A_\theta)$\\
                                        $C:=C \cup \{\delta\}$};
  \node[print, right=of satc] (yes) {YES};
  \node[action, right=of satctheta] (cthetaprime) {$C_{\theta'}:=\text{SubnetTrapConditions}(N, A)$};
  \node[decision, below=of cthetaprime] (satcthetaprime) {$\text{SAT}(C_{\theta'})$};
  \node[action, below=of satcthetaprime] (modelcthetaprime)
      {$A_{\theta'}:=\text{Model}(C_\theta)$\\
       $\delta':=\Delta'(A_{\theta'})$\\
       $C:=C \cup \{\delta'\}$};
  \node[print, right=of satcthetaprime] (dontknow) {Don't know};
  \node[state, right=of yes] (end1) {END};
  \node[state, right=of dontknow] (end2) {END};

  \draw (begin) edge[edge] (c);
  \draw (c) edge[edge] coordinate[pos=.5] (edgein) (satc);
  \draw (satc) edge[edge] node[above]{NO} (yes);
  \draw (yes) edge[edge] (end1);
  \draw (satc) edge[edge] node[right]{YES} (modelc);
  \draw (modelc) edge[edge] (satctheta);
  \draw (satctheta) edge[edge] node[above]{NO} (cthetaprime);
  \draw (cthetaprime) edge[edge] (satcthetaprime);
  \draw (satcthetaprime) edge[edge] node[above]{NO} (dontknow);
  \draw (dontknow) edge[edge] (end2);
  \draw (satctheta) edge[edge] node[right]{YES} (modelctheta);
  \draw (satcthetaprime) edge[edge] node[right]{YES} (modelcthetaprime);
  \draw[edge] (modelctheta.south) -- ([yshift=-0.5cm] modelctheta.south)
  -| ([xshift=-2cm] modelctheta.west) |- (edgein);
  \draw[edge] (modelcthetaprime.south) -- ([yshift=-0.5cm] modelcthetaprime.south)
  -| ([xshift=-2cm] modelctheta.west) |- (edgein);
\end{tikzpicture}

\subsection{State space exploration}
\begin{algorithmic}[1]
\Function{safety}{$N, M, D$}
  \If {$unsafe(N, M)$}
    \State \Return \text{unsafe}
  \ElsIf {$safe(N, M)$}
    \State \Return \text{safe}
  \ElsIf {$D = 0$}
    \State \Return \text{don't know}
  \Else
    \State $\forall M \rightarrow M_i: R_i \gets \Call{safety}{N, M, D-1}$
    \If {$\exists R_i: R_i = \text{unsafe}$}
      \State \Return \text{unsafe}
    \ElsIf {$\exists R_i: R_i = \text{don't know}$}
      \State \Return \text{don't know}
    \Else \ShortComment{$\forall R_i: R_i = safe$}
      \State \Return \text{safe}
    \EndIf
  \EndIf
\EndFunction
\end{algorithmic}

\section{Petri nets tested}

\subsection{Peterson's Algorithm}

Taken from Javier's notes on petri nets
(http://www7.in.tum.de/um/courses/petri/SS2013/PNSkript.pdf, p. 16).
Tested with trap refinement.

\subsubsection{Constraints $C_0$}

\begin{alignat*}{15}
&& p_1 &{}={}& 1
  &{}-{}& u_1 &     &     &     &     &     &     &     &     &{}+{}& u_6 
  &     &     &     &     &     &     &     &     &     &     &     &     \\
&& p_2 &{}={}& 0
  &{}+{}& u_1 &{}-{}& u_2 &{}-{}& u_3 &     &     &     &     &     &     
  &     &     &     &     &     &     &     &     &     &     &     &     \\
&& p_3 &{}={}& 0
  &     &     &{}+{}& u_2 &{}+{}& u_3 &{}-{}& u_4 &{}-{}& u_5 &     &     
  &     &     &     &     &     &     &     &     &     &     &     &     \\
&& p_4 &{}={}& 0
  &     &     &     &     &     &     &{}+{}& u_4 &{}+{}& u_5 &{}-{}& u_6
  &     &     &     &     &     &     &     &     &     &     &     &     \\
&& q_1 &{}={}& 1
  &     &     &     &     &     &     &     &     &     &     &     &     
  &{}-{}& v_1 &     &     &     &     &     &     &     &     &{}+{}& v_6 \\
&& q_2 &{}={}& 0
  &     &     &     &     &     &     &     &     &     &     &     &    
  &{}+{}& v_1 &{}-{}& v_2 &{}-{}& v_3 &     &     &     &     &     &     \\
&& q_3 &{}={}& 0
  &     &     &     &     &     &     &     &     &     &     &     &     
  &     &     &{}+{}& v_2 &{}+{}& v_3 &{}-{}& v_4 &{}-{}& v_5 &     &     \\
&& q_4 &{}={}& 0
  &     &     &     &     &     &     &     &     &     &     &     &     
  &     &     &     &     &     &     &{}+{}& v_4 &{}+{}& v_5 &{}-{}& v_6 \\
&& (m_1=f) &{}={}& 1
  &{}-{}& u_1 &     &     &     &     &     &     &     &     &{}+{}& u_6     
  &     &     &     &     &     &     &     &     &     &     &     &     \\
&& (m_1=t) &{}={}& 0
  &{}+{}& u_1 &     &     &     &     &     &     &     &     &{}-{}& u_6     
  &     &     &     &     &     &     &     &     &     &     &     &     \\
&& (m_2=f) &{}={}& 1
  &     &     &     &     &     &     &     &     &     &     &     &     
  &{}-{}& v_1 &     &     &     &     &     &     &     &     &{}+{}& v_6 \\    
&& (m_2=t) &{}={}& 0
  &     &     &     &     &     &     &     &     &     &     &     &     
  &{}+{}& v_1 &     &     &     &     &     &     &     &     &{}-{}& v_6 \\    
&& (hold=1) &{}={}& 1
  &     &     &{}+{}& u_2 &     &     &     &     &     &     &     &     
  &     &     &     &     &{}-{}& v_3 &     &     &     &     &     &     \\
&& (hold=2) &{}={}& 0
  &     &     &{}-{}& u_2 &     &     &     &     &     &     &     &     
  &     &     &     &     &{}+{}& v_3 &     &     &     &     &     &     \\
&& p_4 &{}\ge{}& 1 \\
&& q_4 &{}\ge{}& 1 \\
&\forall p \in S \cup T:& p &{}\ge{}& 0
\end{alignat*}

\begin{align*}
  \delta_1 &= p_3 \lor q_2 \lor (m_2=f) \lor (hold=2) \\
  \delta_2 &= p_2 \lor q_3 \lor (m_1=f) \lor (hold=1)
\end{align*}

\subsubsection{$A_1$}

\begin{align*}
  p_1 &= 0 \\
  p_2 &= 0 \\
  p_3 &= 0 \\
  p_4 &= 1 \\
  q_1 &= 0 \\
  q_2 &= 0 \\
  q_3 &= 0 \\
  q_4 &= 1 \\
  (m_1=f) &= 0 \\
  (m_1=t) &= 1 \\
  (m_2=f) &= 0 \\
  (m_2=t) &= 1 \\
  (hold=1) &= 1 \\
  (hold=2) &= 0 \\
  u_1 &= 1 \\
  u_2 &= 0 \\
  u_3 &= 1 \\
  u_4 &= 0 \\
  u_5 &= 1 \\
  u_6 &= 0 \\
  v_1 &= 1 \\
  v_2 &= 1 \\
  v_3 &= 0 \\
  v_4 &= 1 \\
  v_5 &= 0 \\
  v_6 &= 0
\end{align*}

\subsubsection{$A_2$}

\begin{align*}
  p_1 &= 0 \\
  p_2 &= 0 \\
  p_3 &= 0 \\
  p_4 &= 1 \\
  q_1 &= 0 \\
  q_2 &= 0 \\
  q_3 &= 0 \\
  q_4 &= 1 \\
  (m_1=f) &= 0 \\
  (m_1=t) &= 1 \\
  (m_2=f) &= 0 \\
  (m_2=t) &= 1 \\
  (hold=1) &= 0 \\
  (hold=2) &= 1 \\
  u_1 &= 1 \\
  u_2 &= 1 \\
  u_3 &= 0 \\
  u_4 &= 0 \\
  u_5 &= 1 \\
  u_6 &= 0 \\
  v_1 &= 2 \\
  v_2 &= 0 \\
  v_3 &= 2 \\
  v_4 &= 0 \\
  v_5 &= 2 \\
  v_6 &= 1
\end{align*}

\subsubsection{$A_{\theta 1}$}
\begin{align*}
  p_1 &= 0 \\
  p_2 &= 0 \\
  p_3 &= 1 \\
  p_4 &= 0 \\
  q_1 &= 0 \\
  q_2 &= 1 \\
  q_3 &= 0 \\
  q_4 &= 0 \\
  (m_1=f) &= 0 \\
  (m_1=t) &= 0 \\
  (m_2=f) &= 1 \\
  (m_2=t) &= 0 \\
  (hold=1) &= 0 \\
  (hold=2) &= 1
\end{align*}

\subsubsection{$A_{\theta 2}$}
\begin{align*}
  p_1 &= 0 \\
  p_2 &= 1 \\
  p_3 &= 0 \\
  p_4 &= 0 \\
  q_1 &= 0 \\
  q_2 &= 0 \\
  q_3 &= 1 \\
  q_4 &= 0 \\
  (m_1=f) &= 1 \\
  (m_1=t) &= 0 \\
  (m_2=f) &= 0 \\
  (m_2=t) &= 0 \\
  (hold=1) &= 1 \\
  (hold=2) &= 0
\end{align*}

\subsubsection{$C_\theta$}

\circled{1}
\begin{align*}
  p_1 &\implies o\_u_1 \\
  p_2 &\implies o\_u_2 \land o\_u_3 \\
  p_3 &\implies o\_u_4 \land o\_u_5 \\
  p_4 &\implies o\_u_6 \\
  q_1 &\implies o\_v_1 \\
  q_2 &\implies o\_v_2 \land o\_v_3 \\
  q_3 &\implies o\_v_4 \land o\_v_5 \\
  q_4 &\implies o\_v_6 \\
  (m_1=f) &\implies o\_u_1 \land o\_v_4 \\
  (m_1=t) &\implies o\_u_6 \\
  (m_2=f) &\implies o\_v_1 \land o\_u_4  \\
  (m_2=t) &\implies o\_v_6 \\
  (hold=1) &\implies o\_v_3 \land o\_v_5 \land o\_u_3 \\
  (hold=2) &\implies o\_u_3 \land o\_u_5 \land o\_v_3 \\
  o\_u_1 &\implies (p_2 \lor (m_1=t)) \\
  o\_u_2 &\implies (p_3 \lor (hold=1)) \\
  o\_u_3 &\implies (p_3 \lor (hold=1)) \\
  o\_u_4 &\implies (p_4 \lor (m_2=f)) \\
  o\_u_5 &\implies (p_4 \lor (hold=2)) \\
  o\_u_6 &\implies (p_1 \lor (m_1=f)) \\
  o\_v_1 &\implies (q_2 \lor (m_2=t)) \\
  o\_v_2 &\implies (q_3 \lor (hold=2)) \\
  o\_v_3 &\implies (q_3 \lor (hold=2)) \\
  o\_v_4 &\implies (q_4 \lor (m_1=f)) \\
  o\_v_5 &\implies (p_4 \lor (hold=1)) \\
  o\_v_6 &\implies (q_1 \lor (m_2=f))
\end{align*}
\circled{2}
\begin{align*}
  p_1 \lor q_1 \lor (m_1=f) \lor (m_2=f) \lor (hold=1)
\end{align*}
$\circled{3}_1$
\begin{align*}
  \neg p_4 \land \neg q_4 \land \neg (m_1=t) \land
  \neg (m_2=t) \land \neg (hold=1)
\end{align*}
$\circled{3}_2$
\begin{align*}
  \neg p_4 \land \neg q_4 \land \neg (m_1=t) \land
  \neg (m_2=t) \land \neg (hold=2)
\end{align*}


\subsection{Cyclic net}

Taken and modified from Stephan Melzer's Dissertation, p. 140.

Tested with trap and subnet trap refinement.

\begin{dot2tex}[dot,options=-tmath]
\input{cyclic-net.dot}
\end{dot2tex}

\subsubsection{Constraints $C_0$}

\begin{alignat*}{6}
&& s_1 &{}={}&   1 &     &     &{}-{}& t_2 &     &     \\
&& s_2 &{}={}&   0 &{}+{}& t_1 &{}-{}& t_2 &     &     \\
&& s_3 &{}={}&   0 &     &     &{}+{}& t_2 &     &     \\
&& s_4 &{}={}&   0 &     &     &     &     &{}+{}& t_3 \\
&& s_5 &{}={}&   1 &{}-{}& t_1 &     &     &{}+{}& t_3 \\
&& s_6 &{}={}&   0 &{}+{}& t_1 &     &     &{}-{}& t_3 \\
&& s_1 &{}\ge{}& 1 \\
&& s_2 &{}\ge{}& 1 \
&& s_4 &{}\ge{}& 1 \\
&& s_5 &{}\ge{}& 1 \\
&\forall p \in S \cup T:& p &{}\ge{}& 0
\end{alignat*}

\begin{align*}
  \delta'_1 &= (t_1 > 0) \land (t_2 = 0) \land (t_3 > 0) \implies (s_3 > 0)
\end{align*}

\subsubsection{$A_1$}
\begin{align*}
  s_1 &= 1 \\
  s_2 &= 1 \\
  s_3 &= 0 \\
  s_4 &= 1 \\
  s_5 &= 1 \\
  s_6 &= 0 \\
  t_1 &= 1 \\
  t_2 &= 0 \\
  t_3 &= 1
\end{align*}

\subsubsection{$A_{\theta'1}$}
\begin{align*}
  s_1 &= 0 \\
  s_2 &= 0 \\
  s_3 &= 1 \\
  s_4 &= 0 \\
  s_5 &= 0 \\
  s_6 &= 0
\end{align*}

\subsubsection{$C_\theta$}

\begin{align*}
  s_1 &\implies o\_t_1 \land o\_t_2 \\
  s_2 &\implies o\_t_2 \\
  s_3 &\implies o\_t_3 \\
  s_4 &\implies true \\
  s_5 &\implies o\_t_1 \\
  s_6 &\implies o\_t_2 \\
  o\_t_1 &\implies (s_1 \lor s_2 \lor s_6) \\
  o\_t_2 &\implies s_3 \\
  o\_t_3 &\implies (s_3 \lor s_4 \lor s_5)
\end{align*}

\begin{align*}
  s_1 \lor s_5
\end{align*}

\begin{align*}
  \neg s_1 \land \neg s_2 \land \neg s_4 \land \neg s_5
\end{align*}

\subsubsection{$C_{\theta'}$}

\begin{align*}
  s_1 &\implies o\_t_1 \land o\_t_2 \\
  s_2 &\implies o\_t_2 \\
  s_3 &\implies o\_t_3 \\
  s_4 &\implies true \\
  s_5 &\implies o\_t_1 \\
  s_6 &\implies o\_t_2 \\
  o\_t_1 &= (t_1 > 0) \implies (s_1 \lor s_2 \lor s_6) \\
  o\_t_2 &= (t_2 > 0) \implies s_3 \\
  o\_t_3 &= (t_3 > 0) \implies (s_3 \lor s_4 \lor s_5)
\end{align*}

\begin{align*}
  (t_1 = 1) \land (t_2 = 0) \land (t_3 = 1)
\end{align*}

\begin{align*}
  s_1 \lor s_2 \lor s_3 \lor s_4 \lor s_5 \lor s_6
\end{align*}

\begin{align*}
  \neg s_1 \land \neg s_2 \land \neg s_4 \land \neg s_5
\end{align*}

\subsection{Empty trap condition net}

Tested with trap, subnet trap and empty trap refinement.

\begin{dot2tex}[dot,options=-tmath]
\input{empty-trap-net.dot}
\end{dot2tex}

\subsection{Constraints $C_0$}

\begin{alignat*}{6}
&& s_1 &{}={}&   1 &     &     &     &     &     &     \\
&& s_2 &{}={}&   0 &     &     &     &     &     &     \\
&& s_3 &{}={}&   0 &{}+{}& t_1 &{}+{}& t_2 &{}-{}& t_3 \\
&& s_4 &{}={}&   0 &     &     &     &     &{}+{}& t_3 \\
&& s_5 &{}={}&   0 &     &     &     &     &{}+{}& t_3 \\
&& s_5 &{}\ge{}& 1 \\
&\forall p \in S \cup T:& p &{}\ge{}& 0
\end{alignat*}

\begin{align*}
  \delta_1 &= (t_1 > 0) \land (t_3 > 0) \implies (t_1 > 0)
  \delta_2 &= (t_1 > 0) \implies false
\end{align*}

\subsection{$A_1$}
\begin{align*}
  s_1 &= 1 \\
  s_2 &= 0 \\
  s_3 &= 0 \\
  s_4 &= 1 \\
  s_5 &= 1 \\
  t_1 &= 0 \\
  t_2 &= 1 \\
  t_3 &= 1
\end{align*}

\subsection{$A_2$}
\begin{align*}
  s_1 &= 1 \\
  s_2 &= 0 \\
  s_3 &= 1 \\
  s_4 &= 1 \\
  s_5 &= 1 \\
  t_1 &= 1 \\
  t_2 &= 1 \\
  t_3 &= 1
\end{align*}

\subsection{Empty trap $A_{\theta 1}$}
\begin{align*}
  s_1 &= false \\
  s_2 &= false \\
  s_3 &= true \\
  s_4 &= true \\
  s_5 &= false \\
  s_6 &= false \\
  o\_t_1 &= false \\
  o\_t_2 &= true \\
  o\_t_3 &= true \\
  i\_t_1 &= true \\
  i\_t_2 &= true \\
  i\_t_3 &= true
\end{align*}

\subsection{Empty trap $A_{\theta 2}$}
\begin{align*}
  s_1 &= false \\
  s_2 &= true \\
  s_3 &= false \\
  s_4 &= false \\
  s_5 &= false \\
  s_6 &= false \\
  o\_t_1 &= true \\
  o\_t_2 &= true \\
  o\_t_3 &= true \\
  i\_t_1 &= true \\
  i\_t_2 &= true \\
  i\_t_3 &= true
\end{align*}

\section{Refinement methods}

\subsection{TrapConditions}

For a petri net $N$ and an assignment $A$,
find a set $S$ that satisfies
\begin{enumerate}
  \item $S$ is a trap in the net $N$.
  \item $S$ is marked in the initial marking $M_0$.
  \item $S$ is unmarked in the assignment $A$.
\end{enumerate}

For such a set $S$, generate a constraint
$\delta = \left( \sum_{s \in S} s \ge 1 \right)$, ensuring the
trap is marked in any assignment.

\subsection{SubnetTrapConditions}

For a petri net $N$ and an assignment $A$,
construct a subnet $N'$ from $N$ that contains only
the transitions that are fired in $A$.
For the net $N'$, find a set $S$ that satisfies
\begin{enumerate}
  \item $S$ is a trap in the subnet $N'$.
  \item $S$ contains a place with an incoming transition in $N'$.
  \item $S$ is unmarked in the assignment $A$.
\end{enumerate}

For such a set $S$, generate a constraint
$\delta = \left( \bigwedge_{t \in T_1} (t > 0) \land
\bigwedge_{t \in T_2} (t = 0) \implies \sum_{s \in S} s \ge 1 \right)$,
where $T_1$ are the transitions fired in $A$ and $T_2$ are the
transitions not fired in $A$. This ensures the trap is marked in the
corresponding subnet.

\subsection{EmptyTrapConditions}

For a petri net $N$ and an assignment $A$,
find a set $S$ that satisfies
\begin{enumerate}
  \item $S$ is a trap in the net $N$.
  \item $S$ is unmarked in the inital marking $M_0$.
  \item a transition in $S^\bullet$ is fired in $A$
  \item no transition in $S^\bullet \setminus ^\bullet S$ is fired in $A$
\end{enumerate}

For such a set $S$, generate a constraint
$\delta = \left( \bigvee_{t \in S^\bullet} (t > 0) \implies
\bigvee_{t \in ^\bullet S \setminus S^\bullet} (t > 0) \right)$
to ensure a proper incoming transition
is fired if an outgoing transition is fired.

\section{Benchmarks}

All benchmarks run on petri nets given by Daniel Kroening.

No refinement methods:
\begin{center}
  \begin{tabular}{ cc | r | r | r | r | }
    \cline{3-5}
    & & \multicolumn{3}{ c| }{Our tool} \\
    \cline{3-5}
    & & positive & don't know & timeout 10 min &
    \multicolumn{1}{ |c }{} \\ \cline{1-6}
    \multicolumn{1}{ |c| }{\multirow{3}{*}{Mist}} &
    \multicolumn{1}{ |c| }{positive} & 8 & 3 & 0 & 11 \\ \cline{2-6}
    \multicolumn{1}{ |c  }{} &
    \multicolumn{1}{ |c| }{negative} & 0 & 28 & 0 & 28 \\ \cline{2-6}
    \multicolumn{1}{ |c  }{} &
    \multicolumn{1}{ |c| }{timeout 1 min} & 15 & 23 & 0 & 38 \\ \cline{1-6}
    \multicolumn{1}{ c }{} &
    \multicolumn{1}{ c| }{} & 23 & 54 & 0 & 77 \\ \cline{3-6}
  \end{tabular}
\end{center}

Trap refinement:
\begin{center}
  \begin{tabular}{ cc | r | r | r | r | }
    \cline{3-5}
    & & \multicolumn{3}{ c| }{Our tool} \\
    \cline{3-5}
    & & positive & don't know & timeout 10 min &
    \multicolumn{1}{ |c }{} \\ \cline{1-6}
    \multicolumn{1}{ |c| }{\multirow{3}{*}{Mist}} &
    \multicolumn{1}{ |c| }{positive} & 8 & 3 & 0 & 11 \\ \cline{2-6}
    \multicolumn{1}{ |c  }{} &
    \multicolumn{1}{ |c| }{negative} & 0 & 28 & 0 & 28 \\ \cline{2-6}
    \multicolumn{1}{ |c  }{} &
    \multicolumn{1}{ |c| }{timeout 1 min} & 15 & 23 & 0 & 38 \\ \cline{1-6}
    \multicolumn{1}{ c }{} &
    \multicolumn{1}{ c| }{} & 23 & 54 & 0 & 77 \\ \cline{3-6}
  \end{tabular}
\end{center}

Trap refinement and subnet trap refinement:
\begin{center}
  \begin{tabular}{ cc | r | r | r | r | }
    \cline{3-5}
    & & \multicolumn{3}{ c| }{Our tool} \\
    \cline{3-5}
    & & positive & don't know & timeout 10 min &
    \multicolumn{1}{ |c }{} \\ \cline{1-6}
    \multicolumn{1}{ |c| }{\multirow{3}{*}{Mist}} &
    \multicolumn{1}{ |c| }{positive} & 8 & 3 & 0 & 11 \\ \cline{2-6}
    \multicolumn{1}{ |c  }{} &
    \multicolumn{1}{ |c| }{negative} & 0 & 28 & 0 & 28 \\ \cline{2-6}
    \multicolumn{1}{ |c  }{} &
    \multicolumn{1}{ |c| }{timeout 1 min} & 15 & 19 & 4 & 38 \\ \cline{1-6}
    \multicolumn{1}{ c }{} &
    \multicolumn{1}{ c| }{} & 23 & 50 & 4 & 77 \\ \cline{3-6}
  \end{tabular}
\end{center}

Trap refinement, subnet trap refinement and empty trap refinement:
\begin{center}
  \begin{tabular}{ cc | r | r | r | r | }
    \cline{3-5}
    & & \multicolumn{3}{ c| }{Our tool} \\
    \cline{3-5}
    & & positive & don't know & timeout 10 min &
    \multicolumn{1}{ |c }{} \\ \cline{1-6}
    \multicolumn{1}{ |c| }{\multirow{3}{*}{Mist}} &
    \multicolumn{1}{ |c| }{positive} & 8 & 3 & 0 & 11 \\ \cline{2-6}
    \multicolumn{1}{ |c  }{} &
    \multicolumn{1}{ |c| }{negative} & 0 & 27 & 1 & 28 \\ \cline{2-6}
    \multicolumn{1}{ |c  }{} &
    \multicolumn{1}{ |c| }{timeout 1 min} & 15 & 16 & 7 & 38 \\ \cline{1-6}
    \multicolumn{1}{ c }{} &
    \multicolumn{1}{ c| }{} & 23 & 46 & 8 & 77 \\ \cline{3-6}
  \end{tabular}
\end{center}

Trap refinement method and state space exploration up to depth 10:
\begin{center}
  \begin{tabular}{ cc | r | r | r | r | r | }
    \cline{3-6}
    & & \multicolumn{4}{ c| }{Our tool} \\
    \cline{3-6}
    & & positive & negative & don't know & timeout 1 min &
    \multicolumn{1}{ |c }{} \\ \cline{1-7}
    \multicolumn{1}{ |c| }{\multirow{3}{*}{Mist}} &
    \multicolumn{1}{ |c| }{positive} & 8 & 0 & 3 & 0 & 11 \\ \cline{2-7}
    \multicolumn{1}{ |c  }{} &
    \multicolumn{1}{ |c| }{negative} & 0 & 2 & 26 & 0 & 28 \\ \cline{2-7}
    \multicolumn{1}{ |c  }{} &
    \multicolumn{1}{ |c| }{timeout 1 min} & 15 & 0 & 18 & 5 & 38 \\ \cline{1-7}
    \multicolumn{1}{ c }{} &
    \multicolumn{1}{ c| }{} & 23 & 2 & 47 & 5 & 77 \\ \cline{3-7}
  \end{tabular}
\end{center}
\end{document}
