#!/bin/bash

# **********************************************************************
# Preamble

function absolute_path {
    (cd "$(dirname "$1")" && pwd)
}

function print_title {
    cat <<EOF
PETRINIZER: The checker for Petri Nets
[$1]
EOF
}

function print_usage {
    cat <<EOF

Usage: $0 [options] input_file
Option list:
 -h | --h | -help | --help    : Prints this help

EOF
}


# **********************************************************************
# Entry point

print_title "$*"

# parse parameters
for a in $@; do
    case $a in
        -h | --h | -help | --help)
            print_usage
            exit 0
            ;;
        -*)
            echo 'ERROR: Unknown option '$a
            exit 2
            ;;
        *) input=$a ;;
    esac
done

if [ -z $input ]; then
    echo 'ERROR: No input file was given'
    exit 1
fi

if [ ! -e $input ]; then
    echo "ERROR: The file $input does not exist"
    exit 2
fi

sysdir=$(absolute_path $0)

set -e
set -o pipefail

echo
echo '* Constructing petri net N from input file'
sicstus -l "$sysdir"/input-file-to-petri-net.pl -- `pwd`/$input 2>/dev/null | tee /tmp/pp-petri-net.pl

echo
echo '* Constructing constraint C_0 for petri net N'
sicstus -l "$sysdir"/petri-net-to-constraints.pl -- /tmp/pp-petri-net.pl 2>/dev/null | tee /tmp/constraints-c.smt2

iter=0
echo
echo '* Checking SAT(C0)'n
# if ! z3 -smt2 /tmp/constraints-c.smt2 | tee /tmp/model-a.smt2; then exit; fi
while z3 -smt2 /tmp/constraints-c.smt2 | tee /tmp/model-a.smt2; do
    ((iter++))

    echo
    echo '* Constructing trap constraints C_theta for model A'
    echo '- model A...'
    cat /tmp/model-a.smt2 | "$sysdir"/smt2-model-to-prolog-model.sh | tee /tmp/model-a.pl
    echo '- constraints C_theta...'
    sicstus -l "$sysdir"/trap-constraints.pl -- /tmp/pp-petri-net.pl /tmp/model-a.pl 2>/dev/null | tee /tmp/constraints-ctheta.smt2

    echo
    echo '* Checking SAT(C_theta)'
    if ! z3 -smt2 /tmp/constraints-ctheta.smt2 | tee /tmp/model-atheta.smt2; then
        echo
        echo '-------------------------------------------'
        echo 'The petri net may not satisfy the property'
        echo '-------------------------------------------'
        echo
        exit 1
    fi

    echo
    echo "* Constructing constraints C_$iter for C_$((iter-1)) and A_theta"
    echo '- model A_theta...'
    cat /tmp/model-atheta.smt2 | "$sysdir"/smt2-model-to-prolog-model.sh | tee /tmp/model-atheta.pl
    echo "- constraint d_$iter..."
    sicstus -l "$sysdir"/delta-constraint.pl -- /tmp/model-atheta.pl 2>/dev/null | tee /tmp/constraint-delta.smt2
    echo "- constraints c_$iter..."
    "$sysdir"/succ-constraints.sh /tmp/constraints-c.smt2 /tmp/constraint-delta.smt2 | tee /tmp/constraints-cn.smt2
    mv /tmp/constraints-cn.smt2 /tmp/constraints-c.smt2
    
done

echo
echo '-------------------------------------------'
echo 'The petri net satisfies the property!'
echo '-------------------------------------------'
echo

set +o pipefail
set +e
