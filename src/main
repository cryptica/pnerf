#!/bin/bash

# **********************************************************************
# Preamble

function absolute_path {
    (cd "$(dirname "$1")" && pwd)
}

function print_title {
    cat <<EOF
PETRINIZER: The checker for Petri Nets
[$1]
EOF
}

function print_usage {
    cat <<EOF

Usage: $0 [options] input_file
Option list:
 -h | --h | -help | --help    : Prints this help
 -v                           : Verbose output
 -t timing_file               : Append timing information to timing_file

EOF
}

function vecho {
    if [ -n "$verbose" ]; then
        echo "$1"
    fi
}


# **********************************************************************
# Entry point

print_title "$*"


# parse parameters
get_timing_file=false
for a in $@; do
    case $a in
        h | --h | -help | --help)
            print_usage
            exit 0
            ;;
        -v | --v)
            verbose=true
            ;;
        -t)
            timing=true
            get_timing_file=true
            ;;
        -*)
            echo 'ERROR: Unknown option '$a
            exit 3
            ;;
        *) if $get_timing_file ; then
             timing_file=$a
             get_timing_file=false
           else
             input=$a
           fi ;;
    esac
done

if [ -z $input ]; then
    echo 'ERROR: No input file was given'
    exit 3
fi

if [ ! -e $input ]; then
    echo "ERROR: The file $input does not exist"
    exit 3
fi

sysdir=$(absolute_path $0)

tmpdir=/tmp/pnerf-$(date +%s%N)
mkdir $tmpdir

set -e
set -o pipefail

if [ -n "$timing" ]; then
  >$tmpdir/z3_time
  >$tmpdir/sicstus_time
  T_start="$(date +%s%N)"
fi

function exit_with {
  result=$1
  iterations=$2
  set +o pipefail
  set +e
  echo
  echo '-------------------------------------------'
  if [[ $result -eq 0 ]]; then
    echo 'The petri net satisfies the property!'
  else
    echo 'The petri net may not satisfy the property'
  fi
  if [ -n "$timing" ]; then
    T_total="$(($(date +%s%N)-T_start))"
    T_z3=0
    while read num ; do
      T_z3=$((T_z3 + num))
    done < $tmpdir/z3_time
    P_z3=$((100*T_z3/T_total))
    T_sicstus=0
    while read num ; do
      T_sicstus=$((T_z3 + num))
    done < $tmpdir/sicstus_time
    P_sicstus=$((100*T_sisctus/T_total))
    echo "Iterations: $iterations"
    echo "Total time: $T_total"
    echo "Z3 time: $T_z3 ($P_z3 %)"
    echo "Sicstus time: $T_sicstus ($P_sicstus %)"
    if [ -n "$timing_file" ]; then
      echo "$input $iterations $T_total $T_z3 $T_sicstus ($P_z3 %) ($P_sicstus %)" >>$timing_file
    fi
  fi
  echo '-------------------------------------------'
  echo
  echo
  exit $result
}

function run_z3 {
  z3_input=$1
  z3_output=$2
  if [ -n "$timing" ]; then
    T="$(date +%s%N)"
  fi
  if [ -z "$verbose" ]; then
    z3 -smt2 $z3_input >$z3_output
    res=$?
  else
    z3 -smt2 $z3_input | tee $z3_output
    res=$?
  fi
  if [ -n "$timing" ]; then
    T=$(($(date +%s%N)-T))
    echo $T >>$tmpdir/z3_time
  fi
  return $res
}

function run_sicstus {
  prolog_file=$1
  pl_output=$2
  pl_input=${@:3}
  if [ -n "$timing" ]; then
    T="$(date +%s%N)"
  fi
  if [ -z "$verbose" ]; then
    sicstus -l "$sysdir"/$prolog_file -- $pl_input 2>/dev/null >$pl_output
    res=$?
  else
    sicstus -l "$sysdir"/$prolog_file -- $pl_input 2>/dev/null | tee $pl_output
    res=$?
  fi
  if [ -n "$timing" ]; then
    T=$(($(date +%s%N)-T))
    echo $T >>$tmpdir/sicstus_time
  fi
  return $res
}

vecho
vecho '* Constructing petri net N from input file'
run_sicstus input-file-to-petri-net.pl $tmpdir/pp-petri-net.pl $(realpath $input)

vecho
vecho '* Constructing constraints C_0 for petri net N'
run_sicstus petri-net-to-constraints.pl $tmpdir/constraints-c.smt2 $tmpdir/pp-petri-net.pl

refinement_methods=( 'trap' 'empty-trap' 'subnet-trap' )

method_count=${#refinement_methods[@]}
iter=0
while
  (
    vecho
    vecho "* Iteration $iter"
    vecho
    vecho "* Checking SAT(C_$iter)"
    run_z3 $tmpdir/constraints-c.smt2 $tmpdir/model-a.smt2
  ); do
    vecho
    vecho "- sat, getting model A for C_$iter"
    if [ -z "$verbose" ]; then
        cat $tmpdir/model-a.smt2 | "$sysdir"/smt2-model-to-prolog-model.sh >$tmpdir/model-a.pl
    else
        cat $tmpdir/model-a.smt2 | "$sysdir"/smt2-model-to-prolog-model.sh | tee $tmpdir/model-a.pl
    fi

    method_index=0
    while [[ $method_index -lt $method_count ]]; do
        method=${refinement_methods[$method_index]}
        vecho
        vecho "* Applying refinement method '$method'"

        vecho "- constructing $method constraints C_theta for petri net N and model A"
        run_sicstus refinement-methods/$method-constraints.pl $tmpdir/constraints-ctheta.smt2 $tmpdir/pp-petri-net.pl $tmpdir/model-a.pl
        vecho '- checking SAT(C_theta)'
        if ( run_z3 $tmpdir/constraints-ctheta.smt2 $tmpdir/model-atheta.smt2 ); then
            vecho "- sat, getting model A_theta for C_theta"
            if [ -z "$verbose" ]; then
                cat $tmpdir/model-atheta.smt2 | "$sysdir"/smt2-model-to-prolog-model.sh >$tmpdir/model-atheta.pl
            else
                cat $tmpdir/model-atheta.smt2 | "$sysdir"/smt2-model-to-prolog-model.sh | tee $tmpdir/model-atheta.pl
            fi

            vecho "- constructing $method constraint delta for petri net N and model A_theta"
            run_sicstus refinement-methods/$method-delta-constraint.pl $tmpdir/constraint-delta.smt2 $tmpdir/pp-petri-net.pl $tmpdir/model-atheta.pl

            vecho "- constructing constraints C_$((iter+1)) for C_$iter and delta"
            if [ -z "$verbose" ]; then    
                "$sysdir"/succ-constraints.sh $tmpdir/constraints-c.smt2 $tmpdir/constraint-delta.smt2 >$tmpdir/constraints-cn.smt2
            else
                "$sysdir"/succ-constraints.sh $tmpdir/constraints-c.smt2 $tmpdir/constraint-delta.smt2 | tee $tmpdir/constraints-cn.smt2
            fi
            mv $tmpdir/constraints-cn.smt2 $tmpdir/constraints-c.smt2
            break
        else
            vecho " - unsat"
            method_index=$((method_index+1))
        fi
        vecho
    done
    if [[ $method_index -ge $method_count ]]; then
        exit_with 2 $iter
    fi
    iter=$((iter+1))
done
vecho " - unsat"

exit_with 0 $iter
